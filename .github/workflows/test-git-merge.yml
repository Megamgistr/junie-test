name: Test Git Merge Flow

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Working branch to checkout'
        required: true
        default: 'junie/pr-39-20145748737'
      merge_branch:
        description: 'Branch to merge'
        required: true
        default: 'main'

jobs:
  test-git-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Fetch branches
        run: |
          git fetch origin +${{ inputs.branch }}:refs/remotes/origin/${{ inputs.branch }}
          git fetch origin +${{ inputs.merge_branch }}:refs/remotes/origin/${{ inputs.merge_branch }}

      - name: Checkout working branch
        run: |
          git checkout --no-track -B ${{ inputs.branch }} origin/${{ inputs.branch }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge branch with git
        run: |
          echo "Merging ${{ inputs.merge_branch }} into ${{ inputs.branch }}"
          git merge origin/${{ inputs.merge_branch }} --no-edit

      - name: Check git status
        run: |
          echo "Git status after merge:"
          git status
          echo "Recent commits:"
          git log --oneline -n 10

      - name: Push changes
        run: |
          git push --set-upstream origin ${{ inputs.branch }}

      - name: Upload workspace as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workspace-after-git-merge
          path: |
            ${{ github.workspace }}
          retention-days: 7
          if-no-files-found: warn
          include-hidden-files: true
